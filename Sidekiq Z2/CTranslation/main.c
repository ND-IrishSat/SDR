#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <stdbool.h>

#define MAX_ARRAY_LENGTH 1024

#include "standardArray.h"
#include "CRC.h"
#include "iq_imbalance.h"

int main(){
    // Declare Variables
    const int data_length = 10;
    double fs = 2.4e9; // carrier frequency 
    double Ts = 1.0 / fs; // sampling period in seconds
    double f0 = 0.0; // homodyne (0 HZ IF)
    double M = 8; // oversampling factor
    double L = 8; // pulse shaping filter length (Is this the ideal length?)
    char pulse_shape[] = "rrc"; // type of pulse shaping, also "rect"
    char scheme[] = "BPSK"; // Modulation scheme 'OOK', 'QPSK', or 'QAM'
    double alpha = 0.5; // roll-off factor of the RRC pulse-shaping filter

    struct Array_Tuple preamble = defineArray((double[]){0,1,0,0,0,0,1,1,0,0,0,1,0,1,0,0,1,1,1,1,0,1,0,0,0,1,1,1,0,0,1,0,0,1,0,1,1,0,1,1,1,0,1,1,0,0,1,1,0,1,0,1,0,1,1,1,1,1,1,0}, 60);// optimal periodic binary code for N = 63 https://ntrs.nasa.gov/citations/19800017860
    struct Array_Tuple data = {randomArray(2,data_length), data_length}; // this points to the random array generated;  creates 256 random bits

    struct Array_Tuple CRC_key = defineArray((double[]){1,0,0,1,1,0,0,0,0,1,1,1}, 12);// Best CRC polynomials: https://users.ece.cmu.edu/~koopman/crc/
    // Working Demo Code Here ----------------------------------------------------
    // calloc(length, size) is used in defineArray() and for the output variable of CRC_encodeData()
    struct Complex_Array_Tuple packet = {defineArray((double[]){-2.245803733286312e-05, -0.00048695843007993207, -0.013213359527118392, 0.02208844311629443, 0.08436229351095999, -0.8242752692451958, 0.248214743011872, -0.0054092425384586725, -1.0503890633503374, -1.0256486182008373, -1.2182363687490334, 0.20807627763750633, 1.3054569816067296, -0.5158860010916787, -0.9896808005543423, -1.3104045234796375, 0.8769108351651732, -1.0409884361164308, 1.0719799454387158, -0.7038887513534442, -1.2169326136154712, 0.6935788859353145, 0.9410422304298427, 0.9751645951188707, 1.3113801172809338, -1.2896777634621344, 1.1818405169768345, -0.9546424971139992, -0.8595580321238513, -1.2701750281183481, 0.8179989253547761, 0.868621264979521, 1.2406426735988616, -0.9728609366104162, -1.2390470246402585, 1.1848317101907755, -1.0619479948892911, -1.1937119133455842, 1.2896704890085762, -1.3470043045405782, 1.056547088890143, 1.2097533003434198, -1.2550141744174237, 1.1378848793216143, 0.8414626858399484, 1.2461664384123727, -1.2556825396849471, 1.064351006755239, 1.0990163564204987, -1.0570055410100998, -1.0966774911766952, 0.9546598556595491, 1.1512355585381313, -1.339295764989305, 1.420329671942571, -1.434610608950123, 1.4225567412798406, -1.3467506815497219, 1.1883917641144899, 0.9222602729012466, 1.0170483700558919, 1.0001707195103688, 0.9207751951347972, 1.2030499571349595, -1.2462113382851876, 1.1991965502987578, 0.8279748399205501, 1.0993258489780169, -1.0499730267719767, -1.0727466590352879, 0.9541674342943108, 1.0875492700178273, -1.1097719929657361, -1.1451901209660715, 1.3381741737531219, -1.3470693149121222, 1.1265252492883344, 1.0578120397204724, -1.1922537983442916, -0.8246354278282667, -1.2238551288201451, 0.9728610945121251, 1.1629500595518563, -1.2724687149694356, 1.1573160566729737, 1.123345279259736, -1.3304738912971248, 1.4424678547234517, -1.4249683230801373, 1.3527687764482008, -1.205884726298432, -0.9407428966354753, -0.9938696184517415, -0.933871341026517, -1.2718394571733427, 1.2416456001012195, -1.2351870146661632, -0.8309232559275869, -1.1994636960601648, 1.0065184244345395, 1.1171238028660717, -1.350473266995027, 1.4492915182891704, -1.3391098339820906, 1.1542136253993391, 1.0309298262457762, -1.2194069107586827, -0.8447690741377306, -1.187929862433703, 1.060299050934522, 0.8448243500813329, 1.0609059519398525, -1.1687434859839207, -0.8500638305071844, -1.2797471092722439, 1.327510617283463, -1.3600785664635406, 1.2344908383238289, 0.9150400138137371, 0.9293936875426259, 1.168680685080808, -1.3425002972077769, 1.4293730204851514, -1.3538653755957164, 1.205741243117411, 0.9403135339834592, 0.9930688021977016, 0.9402902310505391, 1.191897823986365, -1.3199666606269072, 1.358120511291737, -1.2070869380602185, -0.9205827690517371, -1.0207721867650772, -1.0115509228378095, -0.9253861324467229, -1.1786059511515379, 1.0674704162629707, 0.8449743362620836, 1.0612951509138258, -1.191038621585615, -0.824528014282483, -1.2148836415044915, 0.9826194695364875, 1.1226795822266213, -1.266799715245671, 1.2293986964003913, 0.9212387727585903, 0.9911463653880349, 1.0025586985568162, 1.0266762936559568, 1.0290925745890178, 0.9453517639690867, 1.0978333249483252, -1.1941993108902298, -0.9287362214330005, -0.922185760967616, -1.2125339638149293, 1.00255573678438, 1.1369427206201956, -1.3186785771663896, 1.360285783207401, -1.2416882728870944, -0.9368099121133703, -0.9276094572303896, -1.1776789328448947, 1.0655228776883667, 0.8495484833327868, 1.1202448543942425, -1.3350507573344579, 1.4280409808126404, -1.3314926732731842, 1.2172808784390792, 0.857234205069313, 1.1351419464399757, -1.3402893848036583, 1.4290998945301474, -1.3337032867219472, 1.2285935886499602, 0.8311214410239387, 1.083697479407137, -1.0769303387459415, -1.122679959982593, 1.2450865880070698, -1.2210982822431216, -0.9200095302204768, -1.0204346470832766, -1.009847845589202, -0.9126215181282961, -1.2120540278691079, 0.9809920050752309, 1.1336232468279253, -1.245276545746144, 1.245768619998424, 0.8329582482731734, 1.0488557112853558, -1.1067073430553807, -1.0627436828710286, 1.0720358337634872, 0.9079260592789283, 0.9070468109076707, 1.2022502783996547, -1.2573648581099526, 1.1366719268717178, 1.1487378091506277, -1.2392530223128297, 1.1513133390380723, 1.0595626759804713, -1.1940804687827273, -0.9149061416839303, -1.0174058517228444, -1.0250674664840451, -0.9904326093494107, -0.9389263347410802, -1.2631394051770355, 1.3280671671840003, -1.4291117675005798, 1.3353514351556373, -1.2076355447986171, -0.8311281410152501, -1.207617570524432, 0.9953408747592994, 1.1171305031287593, -1.3452894842420964, 1.4296151330435038, -1.3535467387933446, 1.2341434220870178, 0.914896727642978, 0.9293935336232767, 1.1579450018010375, -1.338060711520603, 1.4293730199566865, -1.3538653752883185, 1.205741242925475, 0.9403135338800203, 0.9933271393821905, 0.9408349309583284, 1.1600403280787044, -1.3381277243351142, 1.4291117668434437, -1.3348809788381455, 1.2181377607729875, 0.8498343592708226, 1.0852083950340143, -1.1828762998373736, -0.9092074398714145, -0.953034766546146, -1.287729603859047, 1.3380077063534401, -1.3652122862002243, 1.1347677910819147, 1.1407252980367493, -1.3482460643631264, 1.4495657076436177, -1.3605527887355324, 1.1226025650722906, 1.1390988313498305, -1.2645759884993186, 1.2123020174461723, 0.9200091561366858, 1.0137766139299953, 1.0246572461840553, 0.9221402293871515, 1.086084751762857, -1.074912758524703, -1.050235473000391, 0.9541675723934879, 1.068626418467968, -1.1268825676298817, -1.1166089435465154, 1.3112716084271803, -1.44374838565651, 1.4260424295347716, -1.3332289374123478, 1.1892051388055513, 0.8568983286158292, 1.1808167162539536, -1.348659768522454, 1.3641575303152327, -1.134570338668366, -1.1513840322388216, 1.3282097709027763, -1.3598305674326583, 1.1991593243268253, 0.921566685342844, 1.013853230559043, 1.0242491547536785, 0.942330446814317, 1.085851419684352, -1.1586966647677552, -0.8529142396008289, -1.2927746164826244, 1.3185477752044614, -1.3585187952937388, 1.217680341569219, 0.9136552727462321, 0.9079337779058123, 1.2021270017536267, -1.2577598636651643, 1.1469451491337674, 1.1505479372473355, -1.3441240616142678, 1.3474335018120824, -1.1265256032691116, -1.0400978765296878, 1.065215449419026, 0.8439205904121057, 1.0729923894550886, -1.1825425252180348, -0.8264860147227701, -1.2224992292617805, 0.946248305131462, 1.0503407125371966, -1.1385947432078298, -1.0231874932438056, 1.0453303878726905, 0.8298729623395263, 1.165632668462277, -1.2320776097297645, 1.131272080426128, 1.0652795758746114, -1.1325677405288161, -1.116751852248915, 1.3112716080650646, -1.4437483856643185, 1.426042429460449, -1.3332263042881565, 1.1893036880309333, 0.8478028535885808, 1.1575305877599626, -1.2953626558628832, 1.278739862938416, -0.13973730970962686, 0.03484261370475098, 0.005302902657276629}, 335), defineArray((double[]){2.562100985514567e-23, -6.119303327244631e-07, -3.304493172077157e-05, 8.296252371775857e-05, 0.0004240273088983655, -0.005174690138611758, 0.0017113152727159836, -4.30149626689616e-05, -0.009769238594260427, -0.009295436358974972, -0.01076016049844661, 0.0016662971631196445, 0.011649845026379403, -0.004015903722603872, -0.008196822763464607, -0.01029887180618239, 0.005802375772965657, -0.006764171145560827, 0.006438629979679051, -0.0038398080863326876, -0.006641999539200957, 0.0032046144572348088, 0.004356726801348243, 0.0042533047639669065, 0.005231954548356101, -0.004130576973256986, 0.002956816687198674, -0.0019652522445461687, -0.0015747295100793021, -0.0020234543810037017, 0.0009965947659221798, 0.0009863682909854316, 0.0012804581161906317, -0.0007538771697266772, -0.0007149420150202382, 0.00039025328154475986, -0.0002669640774740564, -0.00015168679061008244, -4.638189920221081e-05, 7.820926802987183e-05, -0.0001509844519236997, -0.0002507217587679189, 0.00021728747888580258, -0.0003152067111356488, -0.00025875694911803304, -0.0003796204949262916, 0.0003829674603405553, -0.00038044561826015844, -0.00040296931524622104, 0.0003172487780608302, 0.00039346096770047356, -0.0003952899928632292, -0.00040556938509793417, 0.00035724841981744915, -0.000428933612103069, 0.0003665893315182023, -0.0003198564185039887, 0.00025537493629210206, -0.00018596808038628954, -0.00013441198760275053, -0.00010063628606572783, -0.00011211036232504357, -9.568310093724386e-05, -0.00014042403234769407, 0.00012341981021371518, -0.00017011691110156713, -0.00010270720473974648, -7.94286372967079e-05, 8.653105526106042e-05, 0.0001238986533253772, -0.00014820601432662117, -9.997045439388841e-05, 1.7485768646949285e-05, 7.35160701045845e-05, -0.00015600949113854512, 4.266498316796152e-05, -4.036693430226057e-05, -3.0084784429715294e-05, -3.7807294184094564e-05, 2.67270371456102e-05, 0.00010889724834174663, -6.947996325717964e-05, -1.1292297700804532e-06, -8.715815434107155e-05, 4.176762269297862e-06, 5.7489598284388155e-06, -8.34978797668029e-05, -3.1872082866007956e-05, 2.2923803733421177e-05, -1.644353656377051e-05, 1.2447791338493497e-05, -2.6138160902633434e-06, 6.55172939905968e-05, 5.281182227634407e-05, 6.20746908811809e-05, -4.521530302439847e-05, -5.0428599748075786e-05, -2.982060217902871e-05, 2.915026188599068e-05, -1.8500668033522016e-05, 5.262024589283709e-05, -0.0001462494266201153, 1.857458387563571e-05, -1.2853070480295381e-05, 1.7438089578047933e-05, 1.4909084854325405e-05, -8.280835681953591e-05, 1.2850989611859487e-05, 0.0001003454484945765, -7.360003708775653e-05, 8.621849412498994e-06, 6.285737903810595e-05, -5.523378240770982e-05, 8.8049888605779e-06, 0.00010165748094637106, -8.260146251234946e-05, -2.9865516615962262e-05, 2.002973464870772e-05, 1.3130813084655246e-05, 6.698264400478715e-05, 5.305773513381018e-05, -6.054848134290358e-05, -3.7878988441181205e-05, 2.7375813376584457e-05, -2.0815070143814784e-05, -1.2475533304162623e-05, 4.612426343728049e-05, 2.8181996803572362e-05, 3.14017786756382e-05, -3.88878589739905e-05, -5.262520009560734e-05, 3.760689616658097e-05, 1.4277419911196132e-05, 8.45998522245317e-05, 7.216912518875906e-05, 5.635061031675215e-05, 6.212475936237527e-05, -4.383282461647986e-05, 3.102637815868836e-05, 9.096171768346872e-05, -8.52398954012401e-05, -9.048938492906e-06, 7.170121224028825e-05, -4.564228567977002e-05, 3.495934708433457e-05, -0.00011979504310347111, 1.716063956649916e-05, 1.0531227044419111e-05, 5.829379764962783e-05, 4.0169116933386206e-05, 4.3966310885851234e-05, 3.605957366889512e-05, 2.6607067133921358e-05, 1.544439677567122e-05, -2.0180690054077965e-05, 4.37538104451074e-05, 0.0001042285872326354, 0.00012360192517035795, -8.256856718433236e-05, -1.2691188313596058e-06, -0.000101902570130874, -1.3247236304303467e-05, 1.1634838626678468e-05, 6.674090022779078e-06, 6.912858831450985e-05, 7.734911788606635e-05, -5.6666833722990306e-05, 2.193504193334639e-05, 9.433169575762124e-05, -9.376258307292051e-05, -8.896226484256253e-06, 5.840635845133502e-06, -6.614408670002625e-06, -2.915388229218774e-06, 5.2753397568716665e-05, -4.942471308772012e-05, -4.678783591999247e-05, 3.199842289641763e-05, -2.518478899987686e-05, -1.2586629620309209e-05, 3.907694751462132e-05, -1.951336383182456e-05, 2.4970227850695803e-05, -0.00011100675956510209, 3.032483036791156e-06, 9.362412562080591e-06, 7.811123335571546e-05, 6.499238085330705e-05, 4.864827260694926e-05, 5.354641649846226e-05, -3.245102880830575e-05, 5.0979355190716724e-05, -0.00014727934184549651, 4.348801091175192e-05, 2.497709583715313e-05, 8.198695848529725e-05, -6.049857077594645e-05, 1.1955185704348725e-05, -7.575336343734751e-05, -6.034839752089294e-07, 4.410974165186543e-05, 4.1084685070580385e-05, -5.7748001125457193e-05, -1.7983160207457605e-05, -1.4240524606523586e-05, -7.094352324871211e-05, -3.0517420575637555e-05, -2.247850929282258e-05, -5.712474247415722e-05, 3.752277930563208e-05, 0.00010897770968898435, 9.532800812411812e-05, 7.895903298299478e-05, 6.416436141412629e-05, 7.364491176975463e-05, -5.797828362807955e-05, -5.412861673220748e-05, 2.7895681748379975e-05, -2.0391475070324905e-05, -3.0353609702687967e-05, 4.1214084918195226e-05, -2.5297231458110137e-05, 5.6462809712887196e-05, -0.00016285671491866882, 1.896442951476729e-05, -1.2915482561826064e-05, 6.14101137386136e-06, 4.017122966964992e-06, 5.763561193433686e-05, 5.221645125974561e-05, -5.912671913310685e-05, -5.427306951255595e-05, 3.977170468993929e-05, -2.993522067590293e-05, -1.8712810489096565e-05, 4.962043977635444e-05, 3.071919163349923e-05, 3.277996420020246e-05, -4.063699476786198e-05, -6.934080962983646e-05, 4.84095484946101e-05, -3.689875379958574e-05, -1.9890722034704433e-05, 4.1909019034891415e-05, -2.2922868260444318e-05, 3.8603315853980025e-05, 0.00010277218346971262, 0.00012079098209161199, -9.628953500806503e-05, -3.5557627589666296e-05, 1.3146382451367788e-05, 1.5724265343797228e-05, -0.00013622314683836567, -2.4960385925365536e-06, 8.436081853635535e-07, -9.66773247179642e-07, 2.020733853302925e-06, -0.00010062367273794282, -2.1597529333561294e-05, -1.3092764841127202e-05, 4.634248910811989e-05, 2.9854489779268523e-05, 3.138132097219026e-05, 2.2135454419813794e-05, -1.4620575690960091e-05, 3.9033360991702626e-05, -9.885214498922545e-05, -2.2800803419653626e-05, -5.439556537711887e-05, 1.9726235011507942e-05, -0.00011173399421249286, -4.752644027994357e-06, -2.341220926627141e-05, 1.462991870315733e-05, -9.852773247664981e-06, -3.6137529444424388e-06, 6.773871778881224e-05, -6.246805821819024e-05, -3.311579810660881e-05, 2.1366380917986483e-05, 4.15373285245213e-06, -9.544021936380709e-05, -3.386202541905137e-05, -4.304442572933276e-07, 1.5637818890357202e-06, 7.18150141545415e-05, 5.331532231911407e-05, 4.258237969850809e-05, 4.4615479735499175e-05, -3.632766846001223e-05, 2.8060979411603792e-05, 0.00012808288131921364, -0.00010154630534109366, -2.7973794661129148e-05, 7.824281738788574e-06, 7.119114169895635e-06, 6.952334764009915e-05, 6.082959676445565e-05, -7.552527732673786e-05, -1.630579629091633e-05, -1.1711124918600824e-05, -9.251660631343084e-05, -5.0752429929301623e-05, 3.432670286473982e-05, 4.1876504642823775e-06, -7.936995810930991e-05, -3.4300336297921064e-06, 5.069787302275364e-05, -4.32262509120207e-05, 2.300487413364749e-05, 0.00011611374074171898, -7.280563951655994e-05, 1.5217895709573881e-05, -0.00010233836515710637, -1.8163889723477045e-05, -6.788513984473665e-05, 1.1509831149947303e-05, 7.334742814080197e-05, -7.472839458561031e-05, -1.5052325033404479e-05, -1.0224353531484986e-05, -6.56751209612838e-05, 2.308225741598502e-05, -0.00011590577956194226, -2.0237105669007605e-07, -2.7570015021405325e-05, 1.824412392442687e-05, -1.2848984994373591e-05, -5.6124442222582616e-06, 7.422492757935828e-05, -5.475853344938386e-05, -3.5292788477025994e-05, 3.466552630580766e-06, 1.7682005418288849e-06, 2.6116507057059174e-07}, 335)};
    struct Complex_Array_Tuple out = IQImbalanceCorrect(packet, 20);
    printComplexArray("Out", out.real.array, out.imaginary.array, out.real.length);
    freeArrayMemory(packet.real);
    freeArrayMemory(packet.imaginary);
    freeArrayMemory(out.real);
    freeArrayMemory(out.imaginary); // when done with the array, need to free its memory
    // ---------------------------------------------------------------------------
    //struct Array_Length_Tuple tuple = CRC_encodeData(data.array, CRC_key.array);
    return 0;
}